trigger:
- develop

pool:
  name: 'Default'

variables:
- group: application-var-group
- name: solution
  value: '**/*.sln'
- name: buildPlatform
  value: 'Any CPU'
- name: system.debug
  value: true
- name: dockerPublicRepo
  value: 'dmfpython/dotnet-mvc-app-repo'

steps:

- task: DotNetCoreCLI@2
  inputs:
    command: 'restore'
    workingDirectory: $(PROJECT_PATH)
  displayName: '[ dotnetTask ] Run dotnet restore'

- task: DotNetCoreCLI@2
  inputs:
    command: 'build'
    projects: '**/*.csproj'
    workingDirectory: $(PROJECT_PATH)
    arguments: '--configuration $(buildConfiguration)' 
  displayName: '[ dotnetTask ] Build application'

- task: DotNetCoreCLI@2
  inputs:
    command: test
    projects: '**/*tests/*.csproj'
    workingDirectory: $(PROJECT_PATH)
    arguments: '--configuration $(buildConfiguration)'
  displayName: '[ dotnetTask ] Test application'

- task: Docker@2
  inputs:
    containerRegistry: 'dockerHubConnection'
    command: 'login'
  displayName: '[ dockerTask ] docker login'

- task: Docker@2
  inputs:
    containerRegistry: 'dockerHubConnection'
    repository: $(dockerPublicRepo)
    command: 'build'
    Dockerfile: '$(PROJECT_PATH)/Dockerfile'
  displayName: '[ dockerTask ] docker build'

    
- task: Docker@2
  inputs:
    containerRegistry: 'dockerHubConnection'
    repository: $(dockerPublicRepo)
    command: 'push'
  displayName: '[ dockerTask ] docker push'

- task: Docker@2
  inputs:
    containerRegistry: 'dockerHubConnection'
    command: 'logout'
  displayName: '[ dockerTask ] docker logout'